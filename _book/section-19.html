<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Notes</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="This is notes from yufree">
  <meta name="generator" content="bookdown 0.3 and GitBook 2.6.7">

  <meta property="og:title" content="Notes" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is notes from yufree" />
  <meta name="github-repo" content="yufree/notes" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Notes" />
  
  <meta name="twitter:description" content="This is notes from yufree" />
  

<meta name="author" content="Miao YU">


<meta name="date" content="2017-01-11">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="section-18.html">
<link rel="next" href="python.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Notes</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>笔记概述</a></li>
<li class="chapter" data-level="1" data-path="section-1.html"><a href="section-1.html"><i class="fa fa-check"></i><b>1</b> 简明数据分析知识框架</a></li>
<li class="chapter" data-level="2" data-path="section-2.html"><a href="section-2.html"><i class="fa fa-check"></i><b>2</b> 数据科学家工具箱</a></li>
<li class="chapter" data-level="3" data-path="r.html"><a href="r.html"><i class="fa fa-check"></i><b>3</b> R语言编程</a></li>
<li class="chapter" data-level="4" data-path="section-4.html"><a href="section-4.html"><i class="fa fa-check"></i><b>4</b> 数据获取与整理</a></li>
<li class="chapter" data-level="5" data-path="section-5.html"><a href="section-5.html"><i class="fa fa-check"></i><b>5</b> 探索性数据分析</a></li>
<li class="chapter" data-level="6" data-path="section-6.html"><a href="section-6.html"><i class="fa fa-check"></i><b>6</b> 可复算性研究</a></li>
<li class="chapter" data-level="7" data-path="section-7.html"><a href="section-7.html"><i class="fa fa-check"></i><b>7</b> 统计推断</a></li>
<li class="chapter" data-level="8" data-path="section-8.html"><a href="section-8.html"><i class="fa fa-check"></i><b>8</b> 回归模型</a></li>
<li class="chapter" data-level="9" data-path="section-9.html"><a href="section-9.html"><i class="fa fa-check"></i><b>9</b> 机器学习实战</a></li>
<li class="chapter" data-level="10" data-path="section-10.html"><a href="section-10.html"><i class="fa fa-check"></i><b>10</b> 开发数据产品</a></li>
<li class="chapter" data-level="11" data-path="section-11.html"><a href="section-11.html"><i class="fa fa-check"></i><b>11</b> 统计学习导论</a></li>
<li class="chapter" data-level="12" data-path="section-12.html"><a href="section-12.html"><i class="fa fa-check"></i><b>12</b> 基因组学数据分析</a></li>
<li class="chapter" data-level="13" data-path="tex.html"><a href="tex.html"><i class="fa fa-check"></i><b>13</b> 简明TEX笔记</a></li>
<li class="chapter" data-level="14" data-path="section-14.html"><a href="section-14.html"><i class="fa fa-check"></i><b>14</b> 生物信息学数据库</a></li>
<li class="chapter" data-level="15" data-path="section-15.html"><a href="section-15.html"><i class="fa fa-check"></i><b>15</b> 流行病学导论</a></li>
<li class="chapter" data-level="16" data-path="section-16.html"><a href="section-16.html"><i class="fa fa-check"></i><b>16</b> 化学品与健康</a></li>
<li class="chapter" data-level="17" data-path="section-17.html"><a href="section-17.html"><i class="fa fa-check"></i><b>17</b> 心理学导论笔记</a></li>
<li class="chapter" data-level="18" data-path="section-18.html"><a href="section-18.html"><i class="fa fa-check"></i><b>18</b> 抑郁</a></li>
<li class="chapter" data-level="19" data-path="section-19.html"><a href="section-19.html"><i class="fa fa-check"></i><b>19</b> 贝叶斯统计</a><ul>
<li class="chapter" data-level="19.1" data-path="section-19.html"><a href="section-19.html#section-19.1"><i class="fa fa-check"></i><b>19.1</b> 贝塔分布</a></li>
<li class="chapter" data-level="19.2" data-path="section-19.html"><a href="section-19.html#section-19.2"><i class="fa fa-check"></i><b>19.2</b> 为什么击球的概率分布符合贝塔分布？</a></li>
<li class="chapter" data-level="19.3" data-path="section-19.html"><a href="section-19.html#section-19.3"><i class="fa fa-check"></i><b>19.3</b> 先验与后验</a></li>
<li class="chapter" data-level="19.4" data-path="section-19.html"><a href="section-19.html#section-19.4"><i class="fa fa-check"></i><b>19.4</b> 经验贝叶斯</a></li>
<li class="chapter" data-level="19.5" data-path="section-19.html"><a href="section-19.html#section-19.5"><i class="fa fa-check"></i><b>19.5</b> 从整体到个人</a></li>
<li class="chapter" data-level="19.6" data-path="section-19.html"><a href="section-19.html#section-19.6"><i class="fa fa-check"></i><b>19.6</b> 可信区间与置信区间</a></li>
<li class="chapter" data-level="19.7" data-path="section-19.html"><a href="section-19.html#section-19.7"><i class="fa fa-check"></i><b>19.7</b> 后验错误率</a></li>
<li class="chapter" data-level="19.8" data-path="section-19.html"><a href="section-19.html#fdr"><i class="fa fa-check"></i><b>19.8</b> 错误发现率（FDR）</a></li>
<li class="chapter" data-level="19.9" data-path="section-19.html"><a href="section-19.html#q"><i class="fa fa-check"></i><b>19.9</b> q值</a></li>
<li class="chapter" data-level="19.10" data-path="section-19.html"><a href="section-19.html#section-19.10"><i class="fa fa-check"></i><b>19.10</b> 贝叶斯视角的假设检验</a><ul>
<li class="chapter" data-level="19.10.1" data-path="section-19.html"><a href="section-19.html#section-19.10.1"><i class="fa fa-check"></i><b>19.10.1</b> 模拟</a></li>
<li class="chapter" data-level="19.10.2" data-path="section-19.html"><a href="section-19.html#section-19.10.2"><i class="fa fa-check"></i><b>19.10.2</b> 数值积分</a></li>
<li class="chapter" data-level="19.10.3" data-path="section-19.html"><a href="section-19.html#section-19.10.3"><i class="fa fa-check"></i><b>19.10.3</b> 解析解</a></li>
<li class="chapter" data-level="19.10.4" data-path="section-19.html"><a href="section-19.html#section-19.10.4"><i class="fa fa-check"></i><b>19.10.4</b> 正态近似求解</a></li>
</ul></li>
<li class="chapter" data-level="19.11" data-path="section-19.html"><a href="section-19.html#section-19.11"><i class="fa fa-check"></i><b>19.11</b> 比例检验</a></li>
<li class="chapter" data-level="19.12" data-path="section-19.html"><a href="section-19.html#section-19.12"><i class="fa fa-check"></i><b>19.12</b> 错误率控制</a></li>
<li class="chapter" data-level="19.13" data-path="section-19.html"><a href="section-19.html#section-19.13"><i class="fa fa-check"></i><b>19.13</b> 影响因子</a><ul>
<li class="chapter" data-level="19.13.1" data-path="section-19.html"><a href="section-19.html#section-19.13.1"><i class="fa fa-check"></i><b>19.13.1</b> 拟合模型</a></li>
<li class="chapter" data-level="19.13.2" data-path="section-19.html"><a href="section-19.html#section-19.13.2"><i class="fa fa-check"></i><b>19.13.2</b> 求后验概率</a></li>
<li class="chapter" data-level="19.13.3" data-path="section-19.html"><a href="section-19.html#section-19.13.3"><i class="fa fa-check"></i><b>19.13.3</b> 考虑更多因素</a></li>
</ul></li>
<li class="chapter" data-level="19.14" data-path="section-19.html"><a href="section-19.html#section-19.14"><i class="fa fa-check"></i><b>19.14</b> 混合概率模型</a><ul>
<li class="chapter" data-level="19.14.1" data-path="section-19.html"><a href="section-19.html#section-19.14.1"><i class="fa fa-check"></i><b>19.14.1</b> 期望最大算法</a></li>
<li class="chapter" data-level="19.14.2" data-path="section-19.html"><a href="section-19.html#section-19.14.2"><i class="fa fa-check"></i><b>19.14.2</b> 分配</a></li>
<li class="chapter" data-level="19.14.3" data-path="section-19.html"><a href="section-19.html#section-19.14.3"><i class="fa fa-check"></i><b>19.14.3</b> 经验贝叶斯收缩</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="20" data-path="python.html"><a href="python.html"><i class="fa fa-check"></i><b>20</b> 数据科学与python简介</a></li>
<li class="chapter" data-level="21" data-path="section-21.html"><a href="section-21.html"><i class="fa fa-check"></i><b>21</b> 生存分析</a></li>
<li class="chapter" data-level="22" data-path="section-22.html"><a href="section-22.html"><i class="fa fa-check"></i><b>22</b> 因果分析</a></li>
<li class="chapter" data-level="23" data-path="section-23.html"><a href="section-23.html"><i class="fa fa-check"></i><b>23</b> 系统思维与公共健康</a></li>
<li class="chapter" data-level="24" data-path="section-24.html"><a href="section-24.html"><i class="fa fa-check"></i><b>24</b> 博弈论</a></li>
<li class="chapter" data-level="25" data-path="section-25.html"><a href="section-25.html"><i class="fa fa-check"></i><b>25</b> 复杂系统</a></li>
<li class="chapter" data-level="26" data-path="section-26.html"><a href="section-26.html"><i class="fa fa-check"></i><b>26</b> 量化投资</a></li>
<li class="divider"></li>
<li><a href="https://github.com/yufree/notes" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="section-19" class="section level1">
<h1><span class="header-section-number">笔记 19</span> 贝叶斯统计</h1>
<div id="section-19.1" class="section level2">
<h2><span class="header-section-number">19.1</span> 贝塔分布</h2>
<ul>
<li><p>贝塔分布的本质是概率分布的分布</p></li>
<li><p>棒球击球率的预测问题，你不可能预测一个刚打出本垒下一个也击中，会有一个先验概率</p></li>
<li><p>这个概率可以用一个参数 <span class="math inline">\(\alpha\)</span> 与 <span class="math inline">\(\beta\)</span> 的贝塔分布来描述，例如一共打了300个球，81个击中，219个击空，那么 <span class="math inline">\(\alpha\)</span> 为81，<span class="math inline">\(\beta\)</span> 为219</p></li>
<li><p>均值为<span class="math inline">\(\frac{\alpha}{\alpha + \beta} = \frac{81}{81+219} = 0.27\)</span></p></li>
<li><p>概率密度分布图，从图上我们可以看出一个大约在0.2-0.35的概率区间，表示击球的先验概率空间可能的取值</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dt">length=</span><span class="dv">100</span>)
db &lt;-<span class="st"> </span><span class="kw">dbeta</span>(x, <span class="dv">81</span>, <span class="dv">219</span>)
<span class="kw">ggplot</span>() +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(x,db)) +<span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Density of beta&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/beta-1.png" width="672" /></p>
</div>
<div id="section-19.2" class="section level2">
<h2><span class="header-section-number">19.2</span> 为什么击球的概率分布符合贝塔分布？</h2>
<ul>
<li>设想球员A打了一个球打中了，那么在没有先验知识的情况下我会认为他击中概率为1</li>
<li>这个球员又打中了一个球，那么还是1</li>
<li>但第三个没打中，我们会认为他击中概率是0吗？</li>
<li>一般而言，这类连续击球问题可以用二项分布来描述，例如10个球打中8个的概率，我们假设这个击球概率为q，那么这个概率应该是个q的函数：</li>
</ul>
<p><span class="math display">\[f(q) \propto q^a(1-q)^b\]</span></p>
<ul>
<li>q对于一个实际问题是确定的常数，所以出现这个场景的概率实际上是a与b的函数</li>
<li>为了保障这个概率函数累积为1，需要除一个跟a与b有关的数</li>
<li>这个数可以用贝塔函数<span class="math inline">\(B(a,b)\)</span>来表示，数学证明<a href="https://en.wikipedia.org/wiki/Conjugate_prior#Example">略</a></li>
<li>如果接着打了一个中了，那么如何更新这个概率？</li>
<li>根据贝叶斯公式，最后推导出的结果如下：</li>
</ul>
<p><span class="math display">\[Beta(\alpha+1,\beta+0)\]</span></p>
<ul>
<li>那么我们对这个击球率的估计就略高了一点，这是贝塔分布的神奇之处，形式非常简单，理解也很直观</li>
</ul>
</div>
<div id="section-19.3" class="section level2">
<h2><span class="header-section-number">19.3</span> 先验与后验</h2>
<ul>
<li>如果我们后续观察的击球少，那么不太容易影响到对概率的先验估计</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dt">length=</span><span class="dv">100</span>)
db &lt;-<span class="st"> </span><span class="kw">dbeta</span>(x, <span class="dv">81+1</span>, <span class="dv">219</span>)
<span class="kw">ggplot</span>() +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(x,db)) +<span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Density of beta&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/beta1-1.png" width="672" /></p>
<ul>
<li>如果后续观察了大量的击球都中了，那么概率会偏向后面数据量的那一部分</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dt">length=</span><span class="dv">100</span>)
db &lt;-<span class="st"> </span><span class="kw">dbeta</span>(x, <span class="dv">81+1000</span>, <span class="dv">219</span>)
<span class="kw">ggplot</span>() +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(x,db)) +<span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Density of beta&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/beta2-1.png" width="672" /></p>
<ul>
<li><p>这是贝叶斯分析的核心思想，通过证据更新经验</p></li>
<li><p>最后得到的均值（后验0.83）一定是介于经验值（先验0.27）与证据值（全击中就是1）之间</p></li>
<li><p>贝塔分布天然适合描述一个对概率的估计场景</p></li>
<li><p>另一种不那么严谨的理解方法是如果一个概率是稳定的，那么多次实验的结果差别不会太大，则有：</p></li>
</ul>
<p><span class="math display">\[\frac{a}{b} = \frac{c}{d} = \frac{a+b}{c+d}\]</span></p>
<ul>
<li>如果每次实验的概率持平，那么不存在不确定度；但如果前面实验的次数少而后面实验的次数多，那么概率会偏重于后面，这就是贝塔分布想说明的事</li>
</ul>
</div>
<div id="section-19.4" class="section level2">
<h2><span class="header-section-number">19.4</span> 经验贝叶斯</h2>
<ul>
<li><p>对于两个球员，一个打了10个球中了4个，另一个打了1000个球中了300个，一般击中概率0.2，你会选哪一个？</p></li>
<li><p>我们对于小样本量的统计推断会有天然的不信任，如何通过统计量来描述？</p></li>
<li><p>下面用MLB的数据说明，首先提取出球员的击球数据：</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(knitr)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(tidyr)
<span class="kw">library</span>(Lahman)
<span class="co"># 拿到击球数据</span>
career &lt;-<span class="st"> </span>Batting %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="st">  </span><span class="kw">anti_join</span>(Pitching, <span class="dt">by =</span> <span class="st">&quot;playerID&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(playerID) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">H =</span> <span class="kw">sum</span>(H), <span class="dt">AB =</span> <span class="kw">sum</span>(AB)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">average =</span> H /<span class="st"> </span>AB)

<span class="co"># 把ID换成球员名字</span>
career &lt;-<span class="st"> </span>Master %&gt;%
<span class="st">  </span><span class="kw">tbl_df</span>() %&gt;%
<span class="st">  </span><span class="kw">select</span>(playerID, nameFirst, nameLast) %&gt;%
<span class="st">  </span><span class="kw">unite</span>(name, nameFirst, nameLast, <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">inner_join</span>(career, <span class="dt">by =</span> <span class="st">&quot;playerID&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">select</span>(-playerID)
<span class="co"># 展示数据</span>
career</code></pre></div>
<pre><code>## # A tibble: 9,429 × 4
##                 name     H    AB average
##                &lt;chr&gt; &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;
## 1         Hank Aaron  3771 12364  0.3050
## 2       Tommie Aaron   216   944  0.2288
## 3          Andy Abad     2    21  0.0952
## 4        John Abadie    11    49  0.2245
## 5     Ed Abbaticchio   772  3044  0.2536
## 6        Fred Abbott   107   513  0.2086
## 7        Jeff Abbott   157   596  0.2634
## 8        Kurt Abbott   523  2044  0.2559
## 9         Ody Abbott    13    70  0.1857
## 10 Frank Abercrombie     0     4  0.0000
## # ... with 9,419 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 击球前5</span>
career %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(average)) %&gt;%
<span class="st">  </span><span class="kw">head</span>(<span class="dv">5</span>) %&gt;%
<span class="st">  </span><span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="right">H</th>
<th align="right">AB</th>
<th align="right">average</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Jeff Banister</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Doc Bass</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Steve Biras</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">C. B. Burns</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Jackie Gallagher</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 击球后5</span>
career %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(average) %&gt;%
<span class="st">  </span><span class="kw">head</span>(<span class="dv">5</span>) %&gt;%
<span class="st">  </span><span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="right">H</th>
<th align="right">AB</th>
<th align="right">average</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Frank Abercrombie</td>
<td align="right">0</td>
<td align="right">4</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Lane Adams</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Horace Allen</td>
<td align="right">0</td>
<td align="right">7</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Pete Allen</td>
<td align="right">0</td>
<td align="right">4</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Walter Alston</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<ul>
<li><p>如果仅考虑击球率会把很多板凳球员与运气球员包括进来，一个先验概率分布很有必要</p></li>
<li><p>那么考虑下如何得到，经验贝叶斯方法认为如果估计一个个体的参数，那么这个个体所在的整体的概率分布可作为先验概率分布</p></li>
<li><p>这个先验概率分布可以直接从数据中得到，然后我们要用极大似然或矩估计的方法拿到贝塔分布的两个参数：</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">career_filtered &lt;-<span class="st"> </span>career %&gt;%
<span class="st">    </span><span class="kw">filter</span>(AB &gt;=<span class="st"> </span><span class="dv">500</span>)

m &lt;-<span class="st"> </span>MASS::<span class="kw">fitdistr</span>(career_filtered$average, dbeta,
                    <span class="dt">start =</span> <span class="kw">list</span>(<span class="dt">shape1 =</span> <span class="dv">1</span>, <span class="dt">shape2 =</span> <span class="dv">10</span>))

alpha0 &lt;-<span class="st"> </span>m$estimate[<span class="dv">1</span>]
beta0 &lt;-<span class="st"> </span>m$estimate[<span class="dv">2</span>]

<span class="co"># 看下拟合效果</span>

<span class="kw">ggplot</span>(career_filtered) +
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(average, <span class="dt">y =</span> ..density..), <span class="dt">binwidth =</span> .<span class="dv">005</span>) +
<span class="st">  </span><span class="kw">stat_function</span>(<span class="dt">fun =</span> function(x) <span class="kw">dbeta</span>(x, alpha0, beta0), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>,
                <span class="dt">size =</span> <span class="dv">1</span>) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Batting average&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/ebayes-1.png" width="672" /></p>
</div>
<div id="section-19.5" class="section level2">
<h2><span class="header-section-number">19.5</span> 从整体到个人</h2>
<ul>
<li><p>当我们估计个人的击球率时，整体可以作为先验函数，个人的数据可以通过贝塔分布更新到个体</p></li>
<li><p>那么如果一个人数据少，我们倾向于认为他是平均水平；数据多则认为符合个人表现</p></li>
<li><p>这事实上是一个分层结构，经验贝叶斯推断里隐含了这么一个从整体到个人的过程</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">career_eb &lt;-<span class="st"> </span>career %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">eb_estimate =</span> (H +<span class="st"> </span>alpha0) /<span class="st"> </span>(AB +<span class="st"> </span>alpha0 +<span class="st"> </span>beta0))
<span class="co"># 击球率高</span>
career_eb %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(eb_estimate)) %&gt;%
<span class="st">  </span><span class="kw">head</span>(<span class="dv">5</span>) %&gt;%
<span class="st">  </span><span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="right">H</th>
<th align="right">AB</th>
<th align="right">average</th>
<th align="right">eb_estimate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Rogers Hornsby</td>
<td align="right">2930</td>
<td align="right">8173</td>
<td align="right">0.358</td>
<td align="right">0.355</td>
</tr>
<tr class="even">
<td align="left">Shoeless Joe Jackson</td>
<td align="right">1772</td>
<td align="right">4981</td>
<td align="right">0.356</td>
<td align="right">0.350</td>
</tr>
<tr class="odd">
<td align="left">Ed Delahanty</td>
<td align="right">2596</td>
<td align="right">7505</td>
<td align="right">0.346</td>
<td align="right">0.343</td>
</tr>
<tr class="even">
<td align="left">Billy Hamilton</td>
<td align="right">2158</td>
<td align="right">6268</td>
<td align="right">0.344</td>
<td align="right">0.340</td>
</tr>
<tr class="odd">
<td align="left">Harry Heilmann</td>
<td align="right">2660</td>
<td align="right">7787</td>
<td align="right">0.342</td>
<td align="right">0.338</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 击球率低</span>
career_eb %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(eb_estimate) %&gt;%
<span class="st">  </span><span class="kw">head</span>(<span class="dv">5</span>) %&gt;%
<span class="st">  </span><span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="right">H</th>
<th align="right">AB</th>
<th align="right">average</th>
<th align="right">eb_estimate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Bill Bergen</td>
<td align="right">516</td>
<td align="right">3028</td>
<td align="right">0.170</td>
<td align="right">0.178</td>
</tr>
<tr class="even">
<td align="left">Ray Oyler</td>
<td align="right">221</td>
<td align="right">1265</td>
<td align="right">0.175</td>
<td align="right">0.191</td>
</tr>
<tr class="odd">
<td align="left">John Vukovich</td>
<td align="right">90</td>
<td align="right">559</td>
<td align="right">0.161</td>
<td align="right">0.196</td>
</tr>
<tr class="even">
<td align="left">John Humphries</td>
<td align="right">52</td>
<td align="right">364</td>
<td align="right">0.143</td>
<td align="right">0.196</td>
</tr>
<tr class="odd">
<td align="left">George Baker</td>
<td align="right">74</td>
<td align="right">474</td>
<td align="right">0.156</td>
<td align="right">0.196</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 整体估计</span>
<span class="kw">ggplot</span>(career_eb, <span class="kw">aes</span>(average, eb_estimate, <span class="dt">color =</span> AB)) +
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> alpha0 /<span class="st"> </span>(alpha0 +<span class="st"> </span>beta0), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) +
<span class="st">  </span><span class="kw">scale_colour_gradient</span>(<span class="dt">trans =</span> <span class="st">&quot;log&quot;</span>, <span class="dt">breaks =</span> <span class="dv">10</span> ^<span class="st"> </span>(<span class="dv">1</span>:<span class="dv">5</span>)) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Batting average&quot;</span>) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Empirical Bayes batting average&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/ebayes2-1.png" width="672" /></p>
<ul>
<li><p>数据点多会收缩到<span class="math inline">\(x=y\)</span>，也就是个人的击球率；数据点少则回归到整体击球率</p></li>
<li><p>这就是经验贝叶斯方法的全貌：先估计整体的参数，然后把整体参数作为先验概率估计个人参数</p></li>
</ul>
</div>
<div id="section-19.6" class="section level2">
<h2><span class="header-section-number">19.6</span> 可信区间与置信区间</h2>
<ul>
<li><p>经验贝叶斯可以给出点估计，但现实中我们可能更关心区间估计</p></li>
<li><p>一般这类区间估计可以用二项式比例估计来进行，不过没有先验经验的限制置信区间大到没意义</p></li>
<li><p>经验贝叶斯会给出一个后验分布，这个分布可以用来求可信区间</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 给出后验分布</span>
career &lt;-<span class="st"> </span>Batting %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="st">  </span><span class="kw">anti_join</span>(Pitching, <span class="dt">by =</span> <span class="st">&quot;playerID&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(playerID) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">H =</span> <span class="kw">sum</span>(H), <span class="dt">AB =</span> <span class="kw">sum</span>(AB)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">average =</span> H /<span class="st"> </span>AB)

career &lt;-<span class="st"> </span>Master %&gt;%
<span class="st">  </span><span class="kw">tbl_df</span>() %&gt;%
<span class="st">  </span>dplyr::<span class="kw">select</span>(playerID, nameFirst, nameLast) %&gt;%
<span class="st">  </span><span class="kw">unite</span>(name, nameFirst, nameLast, <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">inner_join</span>(career, <span class="dt">by =</span> <span class="st">&quot;playerID&quot;</span>)

career0 &lt;-<span class="st"> </span>Batting %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="st">  </span><span class="kw">anti_join</span>(Pitching, <span class="dt">by =</span> <span class="st">&quot;playerID&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(playerID) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">H =</span> <span class="kw">sum</span>(H), <span class="dt">AB =</span> <span class="kw">sum</span>(AB), <span class="dt">year =</span> <span class="kw">mean</span>(yearID)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">average =</span> H /<span class="st"> </span>AB)

career2 &lt;-<span class="st"> </span>Master %&gt;%
<span class="st">  </span><span class="kw">tbl_df</span>() %&gt;%
<span class="st">  </span>dplyr::<span class="kw">select</span>(playerID, nameFirst, nameLast, bats) %&gt;%
<span class="st">  </span><span class="kw">unite</span>(name, nameFirst, nameLast, <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">inner_join</span>(career0, <span class="dt">by =</span> <span class="st">&quot;playerID&quot;</span>)

career_eb &lt;-<span class="st"> </span>career %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">eb_estimate =</span> (H +<span class="st"> </span>alpha0) /<span class="st"> </span>(AB +<span class="st"> </span>alpha0 +<span class="st"> </span>beta0))
career_eb &lt;-<span class="st"> </span>career_eb %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">alpha1 =</span> H +<span class="st"> </span>alpha0,
           <span class="dt">beta1 =</span> AB -<span class="st"> </span>H +<span class="st"> </span>beta0)
<span class="co"># 提取洋基队的数据</span>
yankee_1998 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;brosisc01&quot;</span>, <span class="st">&quot;jeterde01&quot;</span>, <span class="st">&quot;knoblch01&quot;</span>, <span class="st">&quot;martiti02&quot;</span>, <span class="st">&quot;posadjo01&quot;</span>, <span class="st">&quot;strawda01&quot;</span>, <span class="st">&quot;willibe02&quot;</span>)

yankee_1998_career &lt;-<span class="st"> </span>career_eb %&gt;%
<span class="st">    </span><span class="kw">filter</span>(playerID %in%<span class="st"> </span>yankee_1998)

<span class="co"># 展示球员的后验分布</span>
<span class="kw">library</span>(broom)
yankee_beta &lt;-<span class="st"> </span>yankee_1998_career %&gt;%
<span class="st">    </span><span class="kw">inflate</span>(<span class="dt">x =</span> <span class="kw">seq</span>(.<span class="dv">18</span>, .<span class="dv">33</span>, .<span class="dv">0002</span>)) %&gt;%
<span class="st">    </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">density =</span> <span class="kw">dbeta</span>(x, alpha1, beta1))

<span class="kw">ggplot</span>(yankee_beta, <span class="kw">aes</span>(x, density, <span class="dt">color =</span> name)) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">stat_function</span>(<span class="dt">fun =</span> function(x) <span class="kw">dbeta</span>(x, alpha0, beta0),
                  <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/ci-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 提取可信区间</span>
yankee_1998_career &lt;-<span class="st"> </span>yankee_1998_career %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">low  =</span> <span class="kw">qbeta</span>(.<span class="dv">025</span>, alpha1, beta1),
           <span class="dt">high =</span> <span class="kw">qbeta</span>(.<span class="dv">975</span>, alpha1, beta1))
yankee_1998_career %&gt;%
<span class="st">    </span>dplyr::<span class="kw">select</span>(-alpha1, -beta1, -eb_estimate) %&gt;%
<span class="st">    </span>knitr::<span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">playerID</th>
<th align="left">name</th>
<th align="right">H</th>
<th align="right">AB</th>
<th align="right">average</th>
<th align="right">low</th>
<th align="right">high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">brosisc01</td>
<td align="left">Scott Brosius</td>
<td align="right">1001</td>
<td align="right">3889</td>
<td align="right">0.257</td>
<td align="right">0.244</td>
<td align="right">0.271</td>
</tr>
<tr class="even">
<td align="left">jeterde01</td>
<td align="left">Derek Jeter</td>
<td align="right">3465</td>
<td align="right">11195</td>
<td align="right">0.310</td>
<td align="right">0.300</td>
<td align="right">0.317</td>
</tr>
<tr class="odd">
<td align="left">knoblch01</td>
<td align="left">Chuck Knoblauch</td>
<td align="right">1839</td>
<td align="right">6366</td>
<td align="right">0.289</td>
<td align="right">0.277</td>
<td align="right">0.298</td>
</tr>
<tr class="even">
<td align="left">martiti02</td>
<td align="left">Tino Martinez</td>
<td align="right">1925</td>
<td align="right">7111</td>
<td align="right">0.271</td>
<td align="right">0.260</td>
<td align="right">0.280</td>
</tr>
<tr class="odd">
<td align="left">posadjo01</td>
<td align="left">Jorge Posada</td>
<td align="right">1664</td>
<td align="right">6092</td>
<td align="right">0.273</td>
<td align="right">0.262</td>
<td align="right">0.283</td>
</tr>
<tr class="even">
<td align="left">strawda01</td>
<td align="left">Darryl Strawberry</td>
<td align="right">1401</td>
<td align="right">5418</td>
<td align="right">0.259</td>
<td align="right">0.247</td>
<td align="right">0.270</td>
</tr>
<tr class="odd">
<td align="left">willibe02</td>
<td align="left">Bernie Williams</td>
<td align="right">2336</td>
<td align="right">7869</td>
<td align="right">0.297</td>
<td align="right">0.286</td>
<td align="right">0.305</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 绘制可信区间</span>
yankee_1998_career %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">reorder</span>(name, average)) %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(average, name)) +
<span class="st">    </span><span class="kw">geom_point</span>() +
<span class="st">    </span><span class="kw">geom_errorbarh</span>(<span class="kw">aes</span>(<span class="dt">xmin =</span> low, <span class="dt">xmax =</span> high)) +
<span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> alpha0 /<span class="st"> </span>(alpha0 +<span class="st"> </span>beta0), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Estimated batting average (w/ 95% interval)&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Player&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/ci-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 对比置信区间与可信区间</span>
career_eb &lt;-<span class="st"> </span>career_eb %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">low =</span> <span class="kw">qbeta</span>(.<span class="dv">025</span>, alpha1, beta1),
           <span class="dt">high =</span> <span class="kw">qbeta</span>(.<span class="dv">975</span>, alpha1, beta1))

<span class="kw">set.seed</span>(<span class="dv">2016</span>)

some &lt;-<span class="st"> </span>career_eb %&gt;%
<span class="st">    </span><span class="kw">sample_n</span>(<span class="dv">20</span>) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">paste0</span>(name, <span class="st">&quot; (&quot;</span>, H, <span class="st">&quot;/&quot;</span>, AB, <span class="st">&quot;)&quot;</span>))

frequentist &lt;-<span class="st"> </span>some %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(playerID, name, AB) %&gt;%
<span class="st">    </span><span class="kw">do</span>(<span class="kw">tidy</span>(<span class="kw">binom.test</span>(.$H, .$AB))) %&gt;%
<span class="st">    </span>dplyr::<span class="kw">select</span>(playerID, name, estimate, <span class="dt">low =</span> conf.low, <span class="dt">high =</span> conf.high) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">method =</span> <span class="st">&quot;Confidence&quot;</span>)

bayesian &lt;-<span class="st"> </span>some %&gt;%
<span class="st">    </span>dplyr::<span class="kw">select</span>(playerID, name, AB, <span class="dt">estimate =</span> eb_estimate,
           <span class="dt">low =</span> low, <span class="dt">high =</span> high) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">method =</span> <span class="st">&quot;Credible&quot;</span>)

combined &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(frequentist, bayesian)

combined %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">name2 =</span> <span class="kw">reorder</span>(name, -AB)) %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(estimate, name2, <span class="dt">color =</span> method, <span class="dt">group =</span> method)) +
<span class="st">    </span><span class="kw">geom_point</span>() +
<span class="st">    </span><span class="kw">geom_errorbarh</span>(<span class="kw">aes</span>(<span class="dt">xmin =</span> low, <span class="dt">xmax =</span> high)) +
<span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> alpha0 /<span class="st"> </span>(alpha0 +<span class="st"> </span>beta0), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Estimated batting average&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Player&quot;</span>) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/ci-3.png" width="672" /></p>
<ul>
<li>可信区间与置信区间很大的区别在于前者考虑了先验概率进而实现了区间的收缩，后者则可看作无先验贝塔分布给出的区间估计，频率学派目前没有很好的收缩区间估计的方法</li>
</ul>
</div>
<div id="section-19.7" class="section level2">
<h2><span class="header-section-number">19.7</span> 后验错误率</h2>
<ul>
<li>现实问题经常不局限于估计，而是侧重决策，例如如果一个球员的击球率高于某个值，他就可以进入名人堂（击球率大于0.3），这个决策常常伴随区间估计而不是简单的点估计</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 以 Hank Aaron 为例</span>
career_eb %&gt;%
<span class="st">    </span><span class="kw">filter</span>(name ==<span class="st"> &quot;Hank Aaron&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">do</span>(<span class="kw">data_frame</span>(<span class="dt">x =</span> <span class="kw">seq</span>(.<span class="dv">27</span>, .<span class="dv">33</span>, .<span class="dv">0002</span>),
                  <span class="dt">density =</span> <span class="kw">dbeta</span>(x, .$alpha1, .$beta1))) %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x, density)) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">ymax =</span> density *<span class="st"> </span>(x &lt;<span class="st"> </span>.<span class="dv">3</span>)),
                <span class="dt">alpha =</span> .<span class="dv">1</span>, <span class="dt">fill =</span> <span class="st">&quot;red&quot;</span>) +
<span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">xintercept =</span> .<span class="dv">3</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/lp-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 提取该球员数据</span>
career_eb %&gt;%<span class="st"> </span><span class="kw">filter</span>(name ==<span class="st"> &quot;Hank Aaron&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 1 × 10
##    playerID       name     H    AB average eb_estimate alpha1 beta1   low
##       &lt;chr&gt;      &lt;chr&gt; &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;       &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 aaronha01 Hank Aaron  3771 12364   0.305       0.304   3850  8819 0.296
## # ... with 1 more variables: high &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 计算其不进入名人堂的概率</span>
<span class="kw">pbeta</span>(.<span class="dv">3</span>, <span class="dv">3850</span>, <span class="dv">8818</span>)</code></pre></div>
<pre><code>## [1] 0.169</code></pre>
<ul>
<li><p>后验错误率（Posterior Error Probability）可类比经典假设检验中的显著性水平<span class="math inline">\(\alpha\)</span></p></li>
<li><p>后验包括率（Posterior Inclusion Probability）可类比经典假设检验中的置信水平<span class="math inline">\(1-\alpha\)</span></p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 所有球员的后验错误率分布，大部分不超过0.3</span>
career_eb &lt;-<span class="st"> </span>career_eb %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">PEP =</span> <span class="kw">pbeta</span>(.<span class="dv">3</span>, alpha1, beta1))
<span class="kw">ggplot</span>(career_eb, <span class="kw">aes</span>(PEP)) +
<span class="st">    </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> .<span class="dv">02</span>) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Posterior Error Probability (PEP)&quot;</span>) +
<span class="st">    </span><span class="kw">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/ap-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 后验错误率与击球率的关系</span>
career_eb %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(eb_estimate, PEP, <span class="dt">color =</span> AB)) +
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">1</span>) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;(Shrunken) batting average estimate&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Posterior Error Probability (PEP)&quot;</span>) +
<span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">xintercept =</span> .<span class="dv">3</span>) +
<span class="st">    </span><span class="kw">scale_colour_gradient</span>(<span class="dt">trans =</span> <span class="st">&quot;log&quot;</span>, <span class="dt">breaks =</span> <span class="dv">10</span> ^<span class="st"> </span>(<span class="dv">1</span>:<span class="dv">5</span>))</code></pre></div>
<p><img src="Notes_files/figure-html/ap-2.png" width="672" /></p>
<ul>
<li>后验错误率高于0.3的多数是击球率与击球数都高的人，因为贝叶斯方法惩罚了击球数低的人</li>
</ul>
</div>
<div id="fdr" class="section level2">
<h2><span class="header-section-number">19.8</span> 错误发现率（FDR）</h2>
<ul>
<li><p>FDR可用来控制一个整体决策，保证整体犯错的概率低于某个数值，错误发现率越高，越可能把假阳性包括进来</p></li>
<li><p>假如我们把进入名人堂的决策作为一个整体，则可允许一定的整体错误率，因为每个人的后验错误率可以计算且期望值线性可加和，我们可以得到一个整体的错误率</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 取前100个球员</span>
top_players &lt;-<span class="st"> </span>career_eb %&gt;%
<span class="st">    </span><span class="kw">arrange</span>(PEP) %&gt;%
<span class="st">    </span><span class="kw">head</span>(<span class="dv">100</span>)
<span class="co"># 总错率率</span>
<span class="kw">sum</span>(top_players$PEP)</code></pre></div>
<pre><code>## [1] 5</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 平均错误率</span>
<span class="kw">mean</span>(top_players$PEP)</code></pre></div>
<pre><code>## [1] 0.05</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 错误率随所取球员的变化</span>
sorted_PEP &lt;-<span class="st"> </span>career_eb %&gt;%
<span class="st">    </span><span class="kw">arrange</span>(PEP)

<span class="kw">mean</span>(<span class="kw">head</span>(sorted_PEP$PEP, <span class="dv">50</span>))</code></pre></div>
<pre><code>## [1] 0.00183</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">head</span>(sorted_PEP$PEP, <span class="dv">200</span>))</code></pre></div>
<pre><code>## [1] 0.246</code></pre>
<ul>
<li>错误率在排序后前面低后面高，但这个错误率不特指某个球员，而是包含到某个球员的整体犯错的概率</li>
</ul>
</div>
<div id="q" class="section level2">
<h2><span class="header-section-number">19.9</span> q值</h2>
<ul>
<li>q值定义为排序后累积到某个样本的整体平均错误率，类似多重比较中对整体错误率控制的p值</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 生成每个球员的q值</span>
career_eb &lt;-<span class="st"> </span>career_eb %&gt;%
<span class="st">    </span><span class="kw">arrange</span>(PEP) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">qvalue =</span> <span class="kw">cummean</span>(PEP))
<span class="co"># 观察不同q值对名人堂球员数的影响</span>
career_eb %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(qvalue, <span class="kw">rank</span>(PEP))) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;q-value cutoff&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Number of players included&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/qvalue-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 观察小q值部分</span>
career_eb %&gt;%
<span class="st">    </span><span class="kw">filter</span>(qvalue &lt;<span class="st"> </span>.<span class="dv">25</span>) %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(qvalue, <span class="kw">rank</span>(PEP))) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;q-value cutoff&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Number of players included&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/qvalue-2.png" width="672" /></p>
<ul>
<li><p>200个人进入名人堂可能有约1/4的球员不合适，如果是50个人进入名人堂那么基本不会犯错</p></li>
<li><p>q值是一个整体而非个体的平均错误率，具有累积性，不代表q值大的那一个就是错的</p></li>
<li><p>q值在频率学派的多重比较里也有定义，虽然没有空假设（有先验概率），但实质等同</p></li>
</ul>
</div>
<div id="section-19.10" class="section level2">
<h2><span class="header-section-number">19.10</span> 贝叶斯视角的假设检验</h2>
<ul>
<li><p>前面描述的是击球率如何求，如何进行区间估计与多个体的错误率控制，面向的个体或整体，那么如何解决比较问题</p></li>
<li><p>设想多个球员，我们考虑如何去比较他们击球率</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 选三个球员</span>
career_eb %&gt;%
<span class="st">  </span><span class="kw">filter</span>(name %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Hank Aaron&quot;</span>, <span class="st">&quot;Mike Piazza&quot;</span>, <span class="st">&quot;Hideki Matsui&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">inflate</span>(<span class="dt">x =</span> <span class="kw">seq</span>(.<span class="dv">26</span>, .<span class="dv">33</span>, .<span class="dv">00025</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> <span class="kw">dbeta</span>(x, alpha1, beta1)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x, density, <span class="dt">color =</span> name)) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Batting average&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/ht-1.png" width="672" /></p>
<ul>
<li><p>如果两个球员击球率的概率密度曲线比较接近，那么即便均值有不同我们也无法进行区分；如果重叠比较少，那么我们有理由认为他们之间的差异显著</p></li>
<li><p>贝叶斯视角下如何定量描述这个差异是否显著？</p></li>
</ul>
<div id="section-19.10.1" class="section level3">
<h3><span class="header-section-number">19.10.1</span> 模拟</h3>
<ul>
<li>单纯取样比大小然后计算比例</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 提取两人数据</span>
aaron &lt;-<span class="st"> </span>career_eb %&gt;%<span class="st"> </span><span class="kw">filter</span>(name ==<span class="st"> &quot;Hank Aaron&quot;</span>)
piazza &lt;-<span class="st"> </span>career_eb %&gt;%<span class="st"> </span><span class="kw">filter</span>(name ==<span class="st"> &quot;Mike Piazza&quot;</span>)
<span class="co"># 模拟取样10万次</span>
piazza_simulation &lt;-<span class="st"> </span><span class="kw">rbeta</span>(<span class="fl">1e6</span>, piazza$alpha1, piazza$beta1)
aaron_simulation &lt;-<span class="st"> </span><span class="kw">rbeta</span>(<span class="fl">1e6</span>, aaron$alpha1, aaron$beta1)
<span class="co"># 计算一个人超过另一个人的概率</span>
sim &lt;-<span class="st"> </span><span class="kw">mean</span>(piazza_simulation &gt;<span class="st"> </span>aaron_simulation)
sim</code></pre></div>
<pre><code>## [1] 0.606</code></pre>
</div>
<div id="section-19.10.2" class="section level3">
<h3><span class="header-section-number">19.10.2</span> 数值积分</h3>
<ul>
<li>两个概率的联合概率分布，然后积分一个队员大于另一个的概率</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> </span>.<span class="dv">00002</span>
limits &lt;-<span class="st"> </span><span class="kw">seq</span>(.<span class="dv">29</span>, .<span class="dv">33</span>, d)
<span class="kw">sum</span>(<span class="kw">outer</span>(limits, limits, function(x, y) {
  (x &gt;<span class="st"> </span>y) *
<span class="st">    </span><span class="kw">dbeta</span>(x, piazza$alpha1, piazza$beta1) *
<span class="st">    </span><span class="kw">dbeta</span>(y, aaron$alpha1, aaron$beta1) *
<span class="st">    </span>d ^<span class="st"> </span><span class="dv">2</span>
}))</code></pre></div>
<pre><code>## [1] 0.604</code></pre>
</div>
<div id="section-19.10.3" class="section level3">
<h3><span class="header-section-number">19.10.3</span> 解析解</h3>
<ul>
<li>两个贝塔分布一个比另一个高是有含有贝塔函数的解析解的：</li>
</ul>
<p><span class="math display">\[p_A \sim \mbox{Beta}(\alpha_A, \beta_A)\]</span></p>
<p><span class="math display">\[p_B \sim \mbox{Beta}(\alpha_B, \beta_B)\]</span></p>
<p><span class="math display">\[{\rm Pr}(p_B &gt; p_A) = \sum_{i=0}^{\alpha_B-1}\frac{B(\alpha_A+i,\beta_A+\beta_B)}{(\beta_B+i) B(1+i, \beta_B) B(\alpha_A, \beta_A) }\]</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">h &lt;-<span class="st"> </span>function(alpha_a, beta_a,
              alpha_b, beta_b) {
  j &lt;-<span class="st"> </span><span class="kw">seq.int</span>(<span class="dv">0</span>, <span class="kw">round</span>(alpha_b) -<span class="st"> </span><span class="dv">1</span>)
  log_vals &lt;-<span class="st"> </span>(<span class="kw">lbeta</span>(alpha_a +<span class="st"> </span>j, beta_a +<span class="st"> </span>beta_b) -<span class="st"> </span><span class="kw">log</span>(beta_b +<span class="st"> </span>j) -
<span class="st">               </span><span class="kw">lbeta</span>(<span class="dv">1</span> +<span class="st"> </span>j, beta_b) -<span class="st"> </span><span class="kw">lbeta</span>(alpha_a, beta_a))
  <span class="dv">1</span> -<span class="st"> </span><span class="kw">sum</span>(<span class="kw">exp</span>(log_vals))
}

<span class="kw">h</span>(piazza$alpha1, piazza$beta1,
  aaron$alpha1, aaron$beta1)</code></pre></div>
<pre><code>## [1] 0.605</code></pre>
</div>
<div id="section-19.10.4" class="section level3">
<h3><span class="header-section-number">19.10.4</span> 正态近似求解</h3>
<ul>
<li>贝塔分布在<span class="math inline">\(\alpha\)</span>与<span class="math inline">\(\beta\)</span>比较大时接近正态分布，可以直接用正态分布的解析解求，速度快很多</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">h_approx &lt;-<span class="st"> </span>function(alpha_a, beta_a,
                     alpha_b, beta_b) {
  u1 &lt;-<span class="st"> </span>alpha_a /<span class="st"> </span>(alpha_a +<span class="st"> </span>beta_a)
  u2 &lt;-<span class="st"> </span>alpha_b /<span class="st"> </span>(alpha_b +<span class="st"> </span>beta_b)
  var1 &lt;-<span class="st"> </span>alpha_a *<span class="st"> </span>beta_a /<span class="st"> </span>((alpha_a +<span class="st"> </span>beta_a) ^<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>(alpha_a +<span class="st"> </span>beta_a +<span class="st"> </span><span class="dv">1</span>))
  var2 &lt;-<span class="st"> </span>alpha_b *<span class="st"> </span>beta_b /<span class="st"> </span>((alpha_b +<span class="st"> </span>beta_b) ^<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>(alpha_b +<span class="st"> </span>beta_b +<span class="st"> </span><span class="dv">1</span>))
  <span class="kw">pnorm</span>(<span class="dv">0</span>, u2 -<span class="st"> </span>u1, <span class="kw">sqrt</span>(var1 +<span class="st"> </span>var2))
}

<span class="kw">h_approx</span>(piazza$alpha1, piazza$beta1, aaron$alpha1, aaron$beta1)</code></pre></div>
<pre><code>## [1] 0.606</code></pre>
</div>
</div>
<div id="section-19.11" class="section level2">
<h2><span class="header-section-number">19.11</span> 比例检验</h2>
<ul>
<li>这是个列联表问题，频率学派对比两个比例</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">two_players &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(aaron, piazza)

two_players %&gt;%
<span class="st">  </span><span class="kw">transmute</span>(<span class="dt">Player =</span> name, <span class="dt">Hits =</span> H, <span class="dt">Misses =</span> AB -<span class="st"> </span>H) %&gt;%
<span class="st">  </span>knitr::<span class="kw">kable</span>()</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">Player</th>
<th align="right">Hits</th>
<th align="right">Misses</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Hank Aaron</td>
<td align="right">3771</td>
<td align="right">8593</td>
</tr>
<tr class="even">
<td align="left">Mike Piazza</td>
<td align="right">2127</td>
<td align="right">4784</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">prop.test</span>(two_players$H, two_players$AB)</code></pre></div>
<pre><code>## 
##  2-sample test for equality of proportions with continuity
##  correction
## 
## data:  two_players$H out of two_players$AB
## X-squared = 0.1, df = 1, p-value = 0.7
## alternative hypothesis: two.sided
## 95 percent confidence interval:
##  -0.0165  0.0109
## sample estimates:
## prop 1 prop 2 
##  0.305  0.308</code></pre>
<ul>
<li>贝叶斯学派对比两个比例</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">credible_interval_approx &lt;-<span class="st"> </span>function(a, b, c, d) {
  u1 &lt;-<span class="st"> </span>a /<span class="st"> </span>(a +<span class="st"> </span>b)
  u2 &lt;-<span class="st"> </span>c /<span class="st"> </span>(c +<span class="st"> </span>d)
  var1 &lt;-<span class="st"> </span>a *<span class="st"> </span>b /<span class="st"> </span>((a +<span class="st"> </span>b) ^<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>(a +<span class="st"> </span>b +<span class="st"> </span><span class="dv">1</span>))
  var2 &lt;-<span class="st"> </span>c *<span class="st"> </span>d /<span class="st"> </span>((c +<span class="st"> </span>d) ^<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>(c +<span class="st"> </span>d +<span class="st"> </span><span class="dv">1</span>))

  mu_diff &lt;-<span class="st"> </span>u2 -<span class="st"> </span>u1
  sd_diff &lt;-<span class="st"> </span><span class="kw">sqrt</span>(var1 +<span class="st"> </span>var2)

  <span class="kw">data_frame</span>(<span class="dt">posterior =</span> <span class="kw">pnorm</span>(<span class="dv">0</span>, mu_diff, sd_diff),
             <span class="dt">estimate =</span> mu_diff,
             <span class="dt">conf.low =</span> <span class="kw">qnorm</span>(.<span class="dv">025</span>, mu_diff, sd_diff),
             <span class="dt">conf.high =</span> <span class="kw">qnorm</span>(.<span class="dv">975</span>, mu_diff, sd_diff))
}

<span class="kw">credible_interval_approx</span>(piazza$alpha1, piazza$beta1, aaron$alpha1, aaron$beta1)</code></pre></div>
<pre><code>## # A tibble: 1 × 4
##   posterior estimate conf.low conf.high
##       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1     0.606 -0.00182  -0.0151    0.0115</code></pre>
<ul>
<li>多个球员对比一个</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">2016</span>)

intervals &lt;-<span class="st"> </span>career_eb %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;<span class="st"> </span><span class="dv">10</span>) %&gt;%
<span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">20</span>) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(name, H, AB) %&gt;%
<span class="st">  </span><span class="kw">do</span>(<span class="kw">credible_interval_approx</span>(piazza$alpha1, piazza$beta1, .$alpha1, .$beta1)) %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">reorder</span>(<span class="kw">paste0</span>(name, <span class="st">&quot; (&quot;</span>, H, <span class="st">&quot; / &quot;</span>, AB, <span class="st">&quot;)&quot;</span>), -estimate))
f &lt;-<span class="st"> </span>function(H, AB) broom::<span class="kw">tidy</span>(<span class="kw">prop.test</span>(<span class="kw">c</span>(H, piazza$H), <span class="kw">c</span>(AB, piazza$AB)))
prop_tests &lt;-<span class="st"> </span>purrr::<span class="kw">map2_df</span>(intervals$H, intervals$AB, f) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">estimate =</span> estimate1 -<span class="st"> </span>estimate2,
         <span class="dt">name =</span> intervals$name)

all_intervals &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(
  <span class="kw">mutate</span>(intervals, <span class="dt">type =</span> <span class="st">&quot;Credible&quot;</span>),
  <span class="kw">mutate</span>(prop_tests, <span class="dt">type =</span> <span class="st">&quot;Confidence&quot;</span>)
)

<span class="kw">ggplot</span>(all_intervals, <span class="kw">aes</span>(<span class="dt">x =</span> estimate, <span class="dt">y =</span> name, <span class="dt">color =</span> type)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_errorbarh</span>(<span class="kw">aes</span>(<span class="dt">xmin =</span> conf.low, <span class="dt">xmax =</span> conf.high)) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Piazza average - player average&quot;</span>) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Player&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/mp-1.png" width="672" /></p>
<ul>
<li>置信区间与可信区间的主要差异来自于经验贝叶斯的区间收敛</li>
</ul>
</div>
<div id="section-19.12" class="section level2">
<h2><span class="header-section-number">19.12</span> 错误率控制</h2>
<ul>
<li><p>如果我打算交易一个球员，那么如何筛选候选人？</p></li>
<li><p>先选那些击球率更好的球员</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 对比打算交易的球员与其他球员</span>
career_eb_vs_piazza &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(
  career_eb,
  <span class="kw">credible_interval_approx</span>(piazza$alpha1, piazza$beta1,
                           career_eb$alpha1, career_eb$beta1)) %&gt;%
<span class="st">  </span><span class="kw">select</span>(name, posterior, conf.low, conf.high)

career_eb_vs_piazza</code></pre></div>
<pre><code>## # A tibble: 9,429 × 4
##                    name posterior conf.low conf.high
##                   &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1        Rogers Hornsby  2.84e-11   0.0345    0.0639
## 2          Ed Delahanty  7.10e-07   0.0218    0.0518
## 3  Shoeless Joe Jackson  8.77e-08   0.0278    0.0611
## 4         Willie Keeler  4.62e-06   0.0183    0.0472
## 5            Nap Lajoie  1.62e-05   0.0158    0.0441
## 6            Tony Gwynn  1.83e-05   0.0157    0.0442
## 7        Harry Heilmann  7.19e-06   0.0180    0.0476
## 8            Lou Gehrig  1.43e-05   0.0167    0.0461
## 9        Billy Hamilton  7.03e-06   0.0190    0.0503
## 10        Eddie Collins  2.00e-04   0.0113    0.0393
## # ... with 9,419 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 计算q值</span>
career_eb_vs_piazza &lt;-<span class="st"> </span>career_eb_vs_piazza %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(posterior) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">qvalue =</span> <span class="kw">cummean</span>(posterior))

<span class="co"># 筛选那些q值小于0.05的</span>
better &lt;-<span class="st"> </span>career_eb_vs_piazza %&gt;%
<span class="st">  </span><span class="kw">filter</span>(qvalue &lt;<span class="st"> </span>.<span class="dv">05</span>)

better</code></pre></div>
<pre><code>## # A tibble: 49 × 5
##                    name posterior conf.low conf.high   qvalue
##                   &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1        Rogers Hornsby  2.84e-11   0.0345    0.0639 2.84e-11
## 2  Shoeless Joe Jackson  8.77e-08   0.0278    0.0611 4.39e-08
## 3          Ed Delahanty  7.10e-07   0.0218    0.0518 2.66e-07
## 4         Willie Keeler  4.62e-06   0.0183    0.0472 1.35e-06
## 5        Billy Hamilton  7.03e-06   0.0190    0.0503 2.49e-06
## 6        Harry Heilmann  7.19e-06   0.0180    0.0476 3.27e-06
## 7            Lou Gehrig  1.43e-05   0.0167    0.0461 4.85e-06
## 8            Nap Lajoie  1.62e-05   0.0158    0.0441 6.27e-06
## 9            Tony Gwynn  1.83e-05   0.0157    0.0442 7.61e-06
## 10           Bill Terry  3.03e-05   0.0162    0.0472 9.88e-06
## # ... with 39 more rows</code></pre>
<ul>
<li>这样我们筛到一个可交易的群体，总和错误率不超过5%</li>
</ul>
</div>
<div id="section-19.13" class="section level2">
<h2><span class="header-section-number">19.13</span> 影响因子</h2>
<ul>
<li>击球率高除了能力影响外还有可能是因为得到的机会多或者光环效应，例如一开始凭运气打得好，后面给机会多，通过经验累积提高了击球率</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">career %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;=<span class="st"> </span><span class="dv">20</span>) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(AB, average)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>) +
<span class="st">  </span><span class="kw">scale_x_log10</span>()</code></pre></div>
<p><img src="Notes_files/figure-html/if-1.png" width="672" /></p>
<ul>
<li><p>击球数低方差会大，这比较正常，很多人挂在起跑线上了</p></li>
<li><p>直接使用经验贝叶斯方法会导致整体向均值收敛，这高估了新手的数据</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prior_mu &lt;-<span class="st"> </span>alpha0 /<span class="st"> </span>(alpha0 +<span class="st"> </span>beta0)
career_eb %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;=<span class="st"> </span><span class="dv">20</span>) %&gt;%
<span class="st">  </span><span class="kw">gather</span>(type, value, average, eb_estimate) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> plyr::<span class="kw">revalue</span>(type, <span class="kw">c</span>(<span class="dt">average =</span> <span class="st">&quot;Raw&quot;</span>,
                                      <span class="dt">eb_estimate =</span> <span class="st">&quot;With EB Shrinkage&quot;</span>))) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(AB, value)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">scale_x_log10</span>() +
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">size =</span> <span class="fl">1.5</span>, <span class="dt">yintercept =</span> prior_mu) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~type) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;average&quot;</span>) +
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/ife-1.png" width="672" /></p>
<ul>
<li><p>为了如实反应这种情况，我们应该认为击球率符合贝塔分布，但同时贝塔分布的两个参数受击球数的影响，击球数越多，越可能击中</p></li>
<li><p>这个模型可以用贝塔－二项式回归来描述</p></li>
</ul>
<p><span class="math display">\[\mu_i = \mu_0 + \mu_{\mbox{AB}} \cdot \log(\mbox{AB})\]</span></p>
<p><span class="math display">\[\alpha_{0,i} = \mu_i / \sigma_0\]</span></p>
<p><span class="math display">\[\beta_{0,i} = (1 - \mu_i) / \sigma_0\]</span></p>
<p><span class="math display">\[p_i \sim \mbox{Beta}(\alpha_{0,i}, \beta_{0,i})\]</span></p>
<p><span class="math display">\[H_i \sim \mbox{Binom}(\mbox{AB}_i, p_i)\]</span></p>
<div id="section-19.13.1" class="section level3">
<h3><span class="header-section-number">19.13.1</span> 拟合模型</h3>
<ul>
<li>寻找拟合后的模型参数，构建新的先验概率</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(gamlss)
<span class="co"># 拟合模型</span>
fit &lt;-<span class="st"> </span><span class="kw">gamlss</span>(<span class="kw">cbind</span>(H, AB -<span class="st"> </span>H) ~<span class="st"> </span><span class="kw">log</span>(AB),
              <span class="dt">data =</span> career_eb,
              <span class="dt">family =</span> <span class="kw">BB</span>(<span class="dt">mu.link =</span> <span class="st">&quot;identity&quot;</span>))</code></pre></div>
<pre><code>## GAMLSS-RS iteration 1: Global Deviance = 91967 
## GAMLSS-RS iteration 2: Global Deviance = 72747 
## GAMLSS-RS iteration 3: Global Deviance = 68633 
## GAMLSS-RS iteration 4: Global Deviance = 68627 
## GAMLSS-RS iteration 5: Global Deviance = 68627</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 展示拟合参数</span>
td &lt;-<span class="st"> </span><span class="kw">tidy</span>(fit)
td</code></pre></div>
<pre><code>##   parameter        term estimate std.error statistic p.value
## 1        mu (Intercept)   0.1444   0.00161      89.8       0
## 2        mu     log(AB)   0.0151   0.00022      68.6       0
## 3     sigma (Intercept)  -6.3378   0.02483    -255.3       0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 构建新的先验概率</span>
mu_0 &lt;-<span class="st"> </span>td$estimate[<span class="dv">1</span>]
mu_AB &lt;-<span class="st"> </span>td$estimate[<span class="dv">2</span>]
sigma &lt;-<span class="st"> </span><span class="kw">exp</span>(td$estimate[<span class="dv">3</span>])

<span class="co"># 看看AB对先验概率的影响</span>
<span class="kw">crossing</span>(<span class="dt">x =</span> <span class="kw">seq</span>(<span class="fl">0.08</span>, .<span class="dv">35</span>, .<span class="dv">001</span>), <span class="dt">AB =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">10000</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> <span class="kw">dbeta</span>(x, (mu_0 +<span class="st"> </span>mu_AB *<span class="st"> </span><span class="kw">log</span>(AB)) /<span class="st"> </span>sigma,
                         (<span class="dv">1</span> -<span class="st"> </span>(mu_0 +<span class="st"> </span>mu_AB *<span class="st"> </span><span class="kw">log</span>(AB))) /<span class="st"> </span>sigma)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">AB =</span> <span class="kw">factor</span>(AB)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x, density, <span class="dt">color =</span> AB, <span class="dt">group =</span> AB)) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Batting average&quot;</span>) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Prior density&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/fitbb-1.png" width="672" /></p>
</div>
<div id="section-19.13.2" class="section level3">
<h3><span class="header-section-number">19.13.2</span> 求后验概率</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 计算所有拟合值</span>
mu &lt;-<span class="st"> </span><span class="kw">fitted</span>(fit, <span class="dt">parameter =</span> <span class="st">&quot;mu&quot;</span>)
sigma &lt;-<span class="st"> </span><span class="kw">fitted</span>(fit, <span class="dt">parameter =</span> <span class="st">&quot;sigma&quot;</span>)
<span class="co"># 计算所有后验概率</span>
career_eb_wAB &lt;-<span class="st"> </span>career_eb %&gt;%
<span class="st">  </span>dplyr::<span class="kw">select</span>(name, H, AB, <span class="dt">original_eb =</span> eb_estimate) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mu =</span> mu,
         <span class="dt">alpha0 =</span> mu /<span class="st"> </span>sigma,
         <span class="dt">beta0 =</span> (<span class="dv">1</span> -<span class="st"> </span>mu) /<span class="st"> </span>sigma,
         <span class="dt">alpha1 =</span> alpha0 +<span class="st"> </span>H,
         <span class="dt">beta1 =</span> beta0 +<span class="st"> </span>AB -<span class="st"> </span>H,
         <span class="dt">new_eb =</span> alpha1 /<span class="st"> </span>(alpha1 +<span class="st"> </span>beta1))
<span class="co"># 展示拟合后的击球率</span>
<span class="kw">ggplot</span>(career_eb_wAB, <span class="kw">aes</span>(original_eb, new_eb, <span class="dt">color =</span> AB)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Original EB Estimate&quot;</span>) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;EB Estimate w/ AB term&quot;</span>) +
<span class="st">  </span><span class="kw">scale_color_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log&quot;</span>, <span class="dt">breaks =</span> <span class="dv">10</span> ^<span class="st"> </span>(<span class="dv">0</span>:<span class="dv">4</span>))</code></pre></div>
<p><img src="Notes_files/figure-html/fitpo-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 对比</span>
<span class="kw">library</span>(tidyr)

lev &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">raw =</span> <span class="st">&quot;Raw H / AB&quot;</span>, <span class="dt">original_eb =</span> <span class="st">&quot;EB Estimate&quot;</span>, <span class="dt">new_eb =</span> <span class="st">&quot;EB w/ Regression&quot;</span>)

career_eb_wAB %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;=<span class="st"> </span><span class="dv">10</span>) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">raw =</span> H /<span class="st"> </span>AB) %&gt;%
<span class="st">  </span><span class="kw">gather</span>(type, value, raw, original_eb, new_eb) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mu =</span> <span class="kw">ifelse</span>(type ==<span class="st"> &quot;original_eb&quot;</span>, prior_mu,
                     <span class="kw">ifelse</span>(type ==<span class="st"> &quot;new_eb&quot;</span>, mu, <span class="ot">NA</span>))) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="kw">factor</span>(plyr::<span class="kw">revalue</span>(type, lev), lev)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(AB, value)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> mu), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) +
<span class="st">  </span><span class="kw">scale_x_log10</span>() +
<span class="st">  </span><span class="kw">facet_wrap</span>(~type) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;At-Bats (AB)&quot;</span>) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Estimate&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/fitpo-2.png" width="672" /></p>
<ul>
<li>矫正后我们的数据更复合现实了，其实这是贝叶斯分层模型的一个简单版本，通过考虑更多因素，我们可以构建更复杂的模型来挖掘出我们所需要的信息</li>
</ul>
</div>
<div id="section-19.13.3" class="section level3">
<h3><span class="header-section-number">19.13.3</span> 考虑更多因素</h3>
<ul>
<li>现在我们听说左利手跟右利手的表现可能不一样，所以我们要对模型进行完善，考虑把左右手参数加入模型</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 展示数据</span>
career2 %&gt;%
<span class="st">        </span><span class="kw">count</span>(bats)</code></pre></div>
<pre><code>## # A tibble: 4 × 2
##     bats     n
##   &lt;fctr&gt; &lt;int&gt;
## 1      B   767
## 2      L  2653
## 3      R  5351
## 4     NA   658</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 排除NA</span>
career3 &lt;-<span class="st"> </span>career2 %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(bats)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">bats =</span> <span class="kw">relevel</span>(bats, <span class="st">&quot;R&quot;</span>))
<span class="co"># 重建模型</span>
fit2 &lt;-<span class="st"> </span><span class="kw">gamlss</span>(<span class="kw">cbind</span>(H, AB -<span class="st"> </span>H) ~<span class="st"> </span><span class="kw">log</span>(AB) +<span class="st"> </span>bats,
               <span class="dt">data =</span> career3,
               <span class="dt">family =</span> <span class="kw">BB</span>(<span class="dt">mu.link =</span> <span class="st">&quot;identity&quot;</span>))</code></pre></div>
<pre><code>## GAMLSS-RS iteration 1: Global Deviance = 88216 
## GAMLSS-RS iteration 2: Global Deviance = 69532 
## GAMLSS-RS iteration 3: Global Deviance = 65403 
## GAMLSS-RS iteration 4: Global Deviance = 65397 
## GAMLSS-RS iteration 5: Global Deviance = 65397</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 观察参数</span>
<span class="kw">tidy</span>(fit2)</code></pre></div>
<pre><code>##   parameter        term estimate std.error statistic  p.value
## 1        mu (Intercept)  0.14288  0.001651     86.55 0.00e+00
## 2        mu     log(AB)  0.01489  0.000223     66.79 0.00e+00
## 3        mu       batsB -0.00129  0.000998     -1.29 1.98e-01
## 4        mu       batsL  0.00987  0.000640     15.42 6.32e-53
## 5     sigma (Intercept) -6.42525  0.025315   -253.82 0.00e+00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sigma &lt;-<span class="st"> </span><span class="kw">fitted</span>(fit2, <span class="st">&quot;sigma&quot;</span>)[<span class="dv">1</span>]
<span class="kw">crossing</span>(<span class="dt">bats =</span> <span class="kw">c</span>(<span class="st">&quot;L&quot;</span>, <span class="st">&quot;R&quot;</span>),
         <span class="dt">AB =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">10000</span>)) %&gt;%
<span class="st">  </span><span class="kw">augment</span>(fit2, <span class="dt">newdata =</span> .) %&gt;%
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">mu =</span> .fitted) %&gt;%
<span class="st">  </span><span class="kw">crossing</span>(<span class="dt">x =</span> <span class="kw">seq</span>(.<span class="dv">1</span>, .<span class="dv">36</span>, .<span class="dv">0005</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">alpha =</span> mu /<span class="st"> </span>sigma,
         <span class="dt">beta =</span> (<span class="dv">1</span> -<span class="st"> </span>mu) /<span class="st"> </span>sigma,
         <span class="dt">density =</span> <span class="kw">dbeta</span>(x, alpha, beta)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x, density, <span class="dt">color =</span> <span class="kw">factor</span>(AB), <span class="dt">lty =</span> bats)) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Batting average&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Prior density&quot;</span>,
       <span class="dt">color =</span> <span class="st">&quot;AB&quot;</span>,
       <span class="dt">lty =</span> <span class="st">&quot;Batting hand&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/career2-1.png" width="672" /></p>
<ul>
<li>存在先验概率的情况下，可以考虑考察随着击球数增长左右手的不同</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">crossing</span>(<span class="dt">bats =</span> <span class="kw">c</span>(<span class="st">&quot;L&quot;</span>, <span class="st">&quot;R&quot;</span>),
         <span class="dt">AB =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">10000</span>)) %&gt;%
<span class="st">  </span><span class="kw">augment</span>(fit2, <span class="dt">newdata =</span> .) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">H =</span> .<span class="dv">3</span> *<span class="st"> </span>AB,
         <span class="dt">alpha0 =</span> .fitted /<span class="st"> </span>sigma,
         <span class="dt">beta0 =</span> (<span class="dv">1</span> -<span class="st"> </span>.fitted) /<span class="st"> </span>sigma,
         <span class="dt">alpha1 =</span> alpha0 +<span class="st"> </span>H,
         <span class="dt">beta1 =</span> beta0 +<span class="st"> </span>AB -<span class="st"> </span>H,
         <span class="dt">estimate =</span> alpha1 /<span class="st"> </span>(alpha1 +<span class="st"> </span>beta1),
         <span class="dt">conf.low =</span> <span class="kw">qbeta</span>(.<span class="dv">025</span>, alpha1, beta1),
         <span class="dt">conf.high =</span> <span class="kw">qbeta</span>(.<span class="dv">975</span>, alpha1, beta1),
         <span class="dt">record =</span> <span class="kw">paste</span>(H, AB, <span class="dt">sep =</span> <span class="st">&quot; / &quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(estimate, record, <span class="dt">color =</span> bats)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">geom_errorbarh</span>(<span class="kw">aes</span>(<span class="dt">xmin =</span> conf.low, <span class="dt">xmax =</span> conf.high)) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Estimate w/ 95% credible interval&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Batting record&quot;</span>,
       <span class="dt">color =</span> <span class="st">&quot;Batting hand&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/lrcom-1.png" width="672" /></p>
<ul>
<li>另一个要考虑的因素是不同年份的平均击球率可能也有起伏</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">career3 %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">decade =</span> <span class="kw">factor</span>(<span class="kw">round</span>(year -<span class="st"> </span><span class="dv">5</span>, -<span class="dv">1</span>))) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;=<span class="st"> </span><span class="dv">500</span>) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(decade, average)) +
<span class="st">  </span><span class="kw">geom_boxplot</span>() +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Batting average&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/batyear-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 用样条插值来进行拟合</span>
<span class="kw">library</span>(splines)
fit3 &lt;-<span class="st"> </span><span class="kw">gamlss</span>(<span class="kw">cbind</span>(H, AB -<span class="st"> </span>H) ~<span class="st"> </span><span class="dv">0</span> +<span class="st"> </span><span class="kw">ns</span>(year, <span class="dt">df =</span> <span class="dv">5</span>) +<span class="st"> </span>bats +<span class="st"> </span><span class="kw">log</span>(AB),
               <span class="dt">data =</span> career3,
               <span class="dt">family =</span> <span class="kw">BB</span>(<span class="dt">mu.link =</span> <span class="st">&quot;identity&quot;</span>))</code></pre></div>
<pre><code>## GAMLSS-RS iteration 1: Global Deviance = 88204 
## GAMLSS-RS iteration 2: Global Deviance = 69289 
## GAMLSS-RS iteration 3: Global Deviance = 64841 
## GAMLSS-RS iteration 4: Global Deviance = 64832 
## GAMLSS-RS iteration 5: Global Deviance = 64832</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 观察在击球数1000上先验概率的变化</span>
plot_gamlss_fit &lt;-<span class="st"> </span>function(f) {
  career3 %&gt;%
<span class="st">    </span>dplyr::<span class="kw">select</span>(year, bats) %&gt;%
<span class="st">    </span><span class="kw">distinct</span>() %&gt;%
<span class="st">    </span><span class="kw">filter</span>(bats !=<span class="st"> &quot;B&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">AB =</span> <span class="dv">1000</span>) %&gt;%
<span class="st">    </span><span class="kw">augment</span>(f, <span class="dt">newdata =</span> .) %&gt;%
<span class="st">    </span><span class="kw">rename</span>(<span class="dt">mu =</span> .fitted) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">sigma =</span> <span class="kw">fitted</span>(fit3, <span class="st">&quot;sigma&quot;</span>)[<span class="dv">1</span>],
           <span class="dt">alpha0 =</span> mu /<span class="st"> </span>sigma,
           <span class="dt">beta0 =</span> (<span class="dv">1</span> -<span class="st"> </span>mu) /<span class="st"> </span>sigma,
           <span class="dt">conf_low =</span> <span class="kw">qbeta</span>(.<span class="dv">025</span>, alpha0, beta0),
           <span class="dt">conf_high =</span> <span class="kw">qbeta</span>(.<span class="dv">975</span>, alpha0, beta0)) %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year, mu, <span class="dt">color =</span> bats, <span class="dt">group =</span> bats)) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> conf_low, <span class="dt">ymax =</span> conf_high), <span class="dt">linetype =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> .<span class="dv">1</span>) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Year&quot;</span>,
         <span class="dt">y =</span> <span class="st">&quot;Prior distribution (median + 95% quantiles)&quot;</span>,
         <span class="dt">color =</span> <span class="st">&quot;Batting hand&quot;</span>)
}
<span class="kw">plot_gamlss_fit</span>(fit3)</code></pre></div>
<p><img src="Notes_files/figure-html/batyear-2.png" width="672" /></p>
<ul>
<li>同时另一个问题是这些因素会交互影响</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit4 &lt;-<span class="st"> </span><span class="kw">gamlss</span>(<span class="kw">cbind</span>(H, AB -<span class="st"> </span>H) ~<span class="st"> </span><span class="dv">0</span> +<span class="st"> </span><span class="kw">ns</span>(year, <span class="dv">5</span>) *<span class="st"> </span>bats +<span class="st"> </span><span class="kw">log</span>(AB),
               <span class="dt">data =</span> career3,
               <span class="dt">family =</span> <span class="kw">BB</span>(<span class="dt">mu.link =</span> <span class="st">&quot;identity&quot;</span>))</code></pre></div>
<pre><code>## GAMLSS-RS iteration 1: Global Deviance = 88201 
## GAMLSS-RS iteration 2: Global Deviance = 69241 
## GAMLSS-RS iteration 3: Global Deviance = 64708 
## GAMLSS-RS iteration 4: Global Deviance = 64698 
## GAMLSS-RS iteration 5: Global Deviance = 64698</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot_gamlss_fit</span>(fit4)</code></pre></div>
<p><img src="Notes_files/figure-html/interact-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Pitching %&gt;%
<span class="st">  </span>dplyr::<span class="kw">select</span>(playerID, yearID, GS) %&gt;%
<span class="st">  </span><span class="kw">distinct</span>() %&gt;%
<span class="st">  </span><span class="kw">inner_join</span>(dplyr::<span class="kw">select</span>(Master, playerID, throws)) %&gt;%
<span class="st">  </span><span class="kw">count</span>(yearID, throws, <span class="dt">wt =</span> GS) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(throws)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">percent =</span> n /<span class="st"> </span><span class="kw">sum</span>(n)) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(throws ==<span class="st"> &quot;L&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(yearID, percent)) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">geom_smooth</span>() +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>()) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Year&quot;</span>) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;% of games with left-handed pitcher&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/interact-2.png" width="672" /></p>
<ul>
<li>左右手之间的差距伴随年份在逐渐减少</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">players &lt;-<span class="st"> </span><span class="kw">crossing</span>(<span class="dt">year =</span> <span class="kw">c</span>(<span class="dv">1915</span>, <span class="dv">1965</span>, <span class="dv">2015</span>),
                    <span class="dt">bats =</span> <span class="kw">c</span>(<span class="st">&quot;L&quot;</span>, <span class="st">&quot;R&quot;</span>),
                    <span class="dt">H =</span> <span class="dv">30</span>,
                    <span class="dt">AB =</span> <span class="dv">100</span>)

players_posterior &lt;-<span class="st"> </span>players %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mu =</span> <span class="kw">predict</span>(fit4, <span class="dt">what =</span> <span class="st">&quot;mu&quot;</span>, <span class="dt">newdata =</span> players),
         <span class="dt">sigma =</span> <span class="kw">predict</span>(fit4, <span class="dt">what =</span> <span class="st">&quot;sigma&quot;</span>, <span class="dt">newdata =</span> players, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>),
         <span class="dt">alpha0 =</span> mu /<span class="st"> </span>sigma,
         <span class="dt">beta0 =</span> (<span class="dv">1</span> -<span class="st"> </span>mu) /<span class="st"> </span>sigma,
         <span class="dt">alpha1 =</span> alpha0 +<span class="st"> </span>H,
         <span class="dt">beta1 =</span> beta0 +<span class="st"> </span>AB -<span class="st"> </span>H)
players_posterior %&gt;%
<span class="st">  </span><span class="kw">crossing</span>(<span class="dt">x =</span> <span class="kw">seq</span>(.<span class="dv">15</span>, .<span class="dv">3</span>, .<span class="dv">001</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> <span class="kw">dbeta</span>(x, alpha1, beta1)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x, density, <span class="dt">color =</span> bats)) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>year) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Batting average&quot;</span>) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Posterior density&quot;</span>) +
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Posterior distributions for batters with 30 / 100&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/yearcompare-1.png" width="672" /></p>
<ul>
<li>经验贝叶斯对先验概率的估计类似频率学派，但进行的又是贝叶斯分析</li>
</ul>
</div>
</div>
<div id="section-19.14" class="section level2">
<h2><span class="header-section-number">19.14</span> 混合概率模型</h2>
<ul>
<li>用击球概率为例，击球手跟非击球手的概率分布是不一样的，那么实际看到的总体球员概率分布应该是一个混合在一起的两个独立分布</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 找出投球3次以上的人</span>
pitchers &lt;-<span class="st"> </span>Pitching %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(playerID) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">gamesPitched =</span> <span class="kw">sum</span>(G)) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(gamesPitched &gt;<span class="st"> </span><span class="dv">3</span>)

<span class="co"># 参考上一章节的发现找出击球率稳定的选手 </span>

career &lt;-<span class="st"> </span>Batting %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;<span class="st"> </span><span class="dv">0</span>, lgID ==<span class="st"> &quot;NL&quot;</span>, yearID &gt;=<span class="st"> </span><span class="dv">1980</span>) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(playerID) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">H =</span> <span class="kw">sum</span>(H), <span class="dt">AB =</span> <span class="kw">sum</span>(AB), <span class="dt">year =</span> <span class="kw">mean</span>(yearID)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">average =</span> H /<span class="st"> </span>AB,
         <span class="dt">isPitcher =</span> playerID %in%<span class="st"> </span>pitchers$playerID)

<span class="co"># 链接上名字</span>
career &lt;-<span class="st"> </span>Master %&gt;%
<span class="st">  </span><span class="kw">tbl_df</span>() %&gt;%
<span class="st">  </span>dplyr::<span class="kw">select</span>(playerID, nameFirst, nameLast, bats) %&gt;%
<span class="st">  </span><span class="kw">unite</span>(name, nameFirst, nameLast, <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">inner_join</span>(career, <span class="dt">by =</span> <span class="st">&quot;playerID&quot;</span>)</code></pre></div>
<div id="section-19.14.1" class="section level3">
<h3><span class="header-section-number">19.14.1</span> 期望最大算法</h3>
<ul>
<li>将一个分布拆成两个，可以使用期望最大算法</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">2017</span>)

<span class="co"># 先随机分为两组</span>
starting_data &lt;-<span class="st"> </span>career %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;=<span class="st"> </span><span class="dv">20</span>) %&gt;%
<span class="st">  </span>dplyr::<span class="kw">select</span>(-year, -bats, -isPitcher) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cluster =</span> <span class="kw">factor</span>(<span class="kw">sample</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="kw">n</span>(), <span class="dt">replace =</span> <span class="ot">TRUE</span>)))

<span class="co"># 观察效果</span>
starting_data %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(average, <span class="dt">color =</span> cluster)) +
<span class="st">  </span><span class="kw">geom_density</span>()</code></pre></div>
<p><img src="Notes_files/figure-html/EM-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(VGAM)
fit_bb_mle &lt;-<span class="st"> </span>function(x, n) {
  <span class="co"># dbetabinom.ab 是用n、alpha与beta作为参数的二项贝塔分布的似然度函数</span>
  ll &lt;-<span class="st"> </span>function(alpha, beta) {
    -<span class="kw">sum</span>(<span class="kw">dbetabinom.ab</span>(x, n, alpha, beta, <span class="dt">log =</span> <span class="ot">TRUE</span>))
  }
  m &lt;-<span class="st"> </span>stats4::<span class="kw">mle</span>(ll, <span class="dt">start =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">3</span>, <span class="dt">beta =</span> <span class="dv">10</span>), <span class="dt">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>,
                   <span class="dt">lower =</span> <span class="kw">c</span>(<span class="fl">0.001</span>, .<span class="dv">001</span>))
  ab &lt;-<span class="st"> </span>stats4::<span class="kw">coef</span>(m)
  <span class="kw">data_frame</span>(<span class="dt">alpha =</span> ab[<span class="dv">1</span>], <span class="dt">beta =</span> ab[<span class="dv">2</span>], <span class="dt">number =</span> <span class="kw">length</span>(x))
}
<span class="co"># 看下初始参数</span>
<span class="kw">fit_bb_mle</span>(starting_data$H, starting_data$AB)</code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   alpha  beta number
##   &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt;
## 1  12.7  45.3   3310</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 看下随机分拆后的参数并生成各分组样本数的先验概率</span>
fits &lt;-<span class="st"> </span>starting_data %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(cluster) %&gt;%
<span class="st">  </span><span class="kw">do</span>(<span class="kw">fit_bb_mle</span>(.$H, .$AB)) %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prior =</span> number /<span class="st"> </span><span class="kw">sum</span>(number))

fits</code></pre></div>
<pre><code>## # A tibble: 2 × 5
##   cluster alpha  beta number prior
##    &lt;fctr&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt; &lt;dbl&gt;
## 1       A  12.6  45.0   1644 0.497
## 2       B  12.9  45.6   1666 0.503</code></pre>
<ul>
<li>算法优化的期望是将这两个分布分拆开，前面一次分拆已经产生微弱差异，下面就通过贝叶斯思想对数据更新这个差异重新分组让两者分开</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">assignments &lt;-<span class="st"> </span>starting_data %&gt;%
<span class="st">  </span>dplyr::<span class="kw">select</span>(-cluster) %&gt;%
<span class="st">  </span><span class="kw">crossing</span>(fits) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">likelihood =</span> prior *<span class="st"> </span>VGAM::<span class="kw">dbetabinom.ab</span>(H, AB, alpha, beta)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(playerID) %&gt;%
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">1</span>, likelihood) %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>()
<span class="co"># 去除掉原有分组，根据更新的后验概率重新分组</span>
assignments</code></pre></div>
<pre><code>## # A tibble: 3,310 × 11
##     playerID               name     H    AB average cluster alpha  beta
##        &lt;chr&gt;              &lt;chr&gt; &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;  &lt;fctr&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  abbotje01        Jeff Abbott    11    42  0.2619       B  12.9  45.6
## 2  abbotji01         Jim Abbott     2    21  0.0952       A  12.6  45.0
## 3  abbotku01        Kurt Abbott   475  1860  0.2554       B  12.9  45.6
## 4  abbotky01        Kyle Abbott     3    31  0.0968       A  12.6  45.0
## 5  abercre01 Reggie Abercrombie    86   386  0.2228       B  12.9  45.6
## 6  abnersh01        Shawn Abner   110   531  0.2072       B  12.9  45.6
## 7  abreubo01        Bobby Abreu  1607  5395  0.2979       B  12.9  45.6
## 8  abreuto01         Tony Abreu   129   509  0.2534       B  12.9  45.6
## 9  acevejo01       Jose Acevedo     8   101  0.0792       A  12.6  45.0
## 10 aceveju01       Juan Acevedo     6    65  0.0923       A  12.6  45.0
## # ... with 3,300 more rows, and 3 more variables: number &lt;int&gt;,
## #   prior &lt;dbl&gt;, likelihood &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 观察更新后概率分布</span>
<span class="kw">ggplot</span>(assignments, <span class="kw">aes</span>(average, <span class="dt">fill =</span> cluster)) +
<span class="st">  </span><span class="kw">geom_histogram</span>()</code></pre></div>
<p><img src="Notes_files/figure-html/EMbayes-1.png" width="672" /></p>
<ul>
<li>不断重复这个过程，最终分拆数据（其实就是第一步分拆最重要，后面直接收敛了）</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1987</span>)

iterate_em &lt;-<span class="st"> </span>function(state, ...) {
  fits &lt;-<span class="st"> </span>state$assignments %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(cluster) %&gt;%
<span class="st">    </span><span class="kw">do</span>(<span class="kw">mutate</span>(<span class="kw">fit_bb_mle</span>(.$H, .$AB), <span class="dt">number =</span> <span class="kw">nrow</span>(.))) %&gt;%
<span class="st">    </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">prior =</span> number /<span class="st"> </span><span class="kw">sum</span>(number))

  assignments &lt;-<span class="st"> </span>assignments %&gt;%
<span class="st">    </span>dplyr::<span class="kw">select</span>(playerID:average) %&gt;%
<span class="st">    </span><span class="kw">crossing</span>(fits) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">likelihood =</span> prior *<span class="st"> </span>VGAM::<span class="kw">dbetabinom.ab</span>(H, AB, alpha, beta)) %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(playerID) %&gt;%
<span class="st">    </span><span class="kw">top_n</span>(<span class="dv">1</span>, likelihood) %&gt;%
<span class="st">    </span><span class="kw">ungroup</span>()
  
  <span class="kw">list</span>(<span class="dt">assignments =</span> assignments,
       <span class="dt">fits =</span> fits)
}

<span class="kw">library</span>(purrr)
<span class="co"># 使用purrr包存储中间结果</span>
iterations &lt;-<span class="st"> </span><span class="kw">accumulate</span>(<span class="dv">1</span>:<span class="dv">5</span>, iterate_em, <span class="dt">.init =</span> <span class="kw">list</span>(<span class="dt">assignments =</span> starting_data))

assignment_iterations &lt;-<span class="st"> </span>iterations %&gt;%
<span class="st">  </span><span class="kw">map_df</span>(<span class="st">&quot;assignments&quot;</span>, <span class="dt">.id =</span> <span class="st">&quot;iteration&quot;</span>)
<span class="co"># 观察收敛过程</span>
assignment_iterations %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(average, <span class="dt">fill =</span> cluster)) +
<span class="st">  </span><span class="kw">geom_histogram</span>() +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>iteration)</code></pre></div>
<p><img src="Notes_files/figure-html/EMrepeat-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit_iterations &lt;-<span class="st"> </span>iterations %&gt;%
<span class="st">  </span><span class="kw">map_df</span>(<span class="st">&quot;fits&quot;</span>, <span class="dt">.id =</span> <span class="st">&quot;iteration&quot;</span>)
<span class="co"># 两个分布的收敛过程</span>
fit_iterations %&gt;%
<span class="st">  </span><span class="kw">crossing</span>(<span class="dt">x =</span> <span class="kw">seq</span>(.<span class="dv">001</span>, .<span class="dv">4</span>, .<span class="dv">001</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> prior *<span class="st"> </span><span class="kw">dbeta</span>(x, alpha, beta)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x, density, <span class="dt">color =</span> iteration, <span class="dt">group =</span> iteration)) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>cluster)</code></pre></div>
<p><img src="Notes_files/figure-html/EMrepeat-2.png" width="672" /></p>
</div>
<div id="section-19.14.2" class="section level3">
<h3><span class="header-section-number">19.14.2</span> 分配</h3>
<ul>
<li>得到每个选手在两个分布中后验概率后要对其进行分配，这里我们认为拆分出的两个分布其实就是是否是击球手的两个分组，由于两组重叠较多，直接分配会有困难</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 找6个击球数100的选手进行分配</span>
batter_100 &lt;-<span class="st"> </span>career %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB ==<span class="st"> </span><span class="dv">100</span>) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(average)
batter_100</code></pre></div>
<pre><code>## # A tibble: 5 × 8
##    playerID            name   bats     H    AB  year average isPitcher
##       &lt;chr&gt;           &lt;chr&gt; &lt;fctr&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;     &lt;lgl&gt;
## 1 dejesjo01   Jose de Jesus      R    11   100  1990    0.11      TRUE
## 2 mahonmi02    Mike Mahoney      R    18   100  2002    0.18     FALSE
## 3 cancero01 Robinson Cancel      R    20   100  2007    0.20     FALSE
## 4 buschmi01      Mike Busch      R    22   100  1996    0.22     FALSE
## 5 shealry01     Ryan Shealy      R    32   100  2006    0.32     FALSE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 前面算法得到的最终结果</span>
final_parameters &lt;-<span class="st"> </span>fit_iterations %&gt;%
<span class="st">  </span><span class="kw">filter</span>(iteration ==<span class="st"> </span><span class="kw">max</span>(iteration))

final_parameters</code></pre></div>
<pre><code>## # A tibble: 2 × 6
##   iteration cluster alpha  beta number prior
##       &lt;chr&gt;  &lt;fctr&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt; &lt;dbl&gt;
## 1         5       A  36.4   255    851 0.257
## 2         5       B 111.4   328   2459 0.743</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 观察球员位置</span>
final_parameters %&gt;%
<span class="st">  </span><span class="kw">crossing</span>(<span class="dt">x =</span> <span class="dv">0</span>:<span class="dv">45</span>) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> prior *<span class="st"> </span>VGAM::<span class="kw">dbetabinom.ab</span>(x, <span class="dv">100</span>, alpha, beta)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x, density)) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">color =</span> cluster)) +
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="kw">aes</span>(<span class="dt">xintercept =</span> H), <span class="dt">data =</span> batter_100, <span class="dt">lty =</span> <span class="dv">2</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">x =</span> H, <span class="dt">y =</span> -.<span class="dv">022</span>, <span class="dt">label =</span> name), <span class="dt">data =</span> batter_100, <span class="dt">hjust =</span> <span class="dv">1</span>, <span class="dt">vjust =</span> <span class="dv">1</span>, <span class="dt">angle =</span> <span class="dv">270</span>) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;H (out of 100 at-bats)&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Likelihood of this H out of 100 hits&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/assign-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 根据贝叶斯理论，我们可以用在A分组的似然度比上两个分组似然度的和得到后验概率</span>

final_parameters %&gt;%
<span class="st">  </span><span class="kw">crossing</span>(<span class="dt">H =</span> <span class="dv">1</span>:<span class="dv">40</span>) %&gt;%
<span class="st">  </span><span class="kw">transmute</span>(H, cluster, <span class="dt">likelihood =</span> prior *<span class="st"> </span>VGAM::<span class="kw">dbetabinom.ab</span>(H, <span class="dv">100</span>, alpha, beta)) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(cluster, likelihood) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">probability_A =</span> A /<span class="st"> </span>(A +<span class="st"> </span>B)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(H, probability_A)) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="kw">aes</span>(<span class="dt">xintercept =</span> H), <span class="dt">data =</span> batter_100, <span class="dt">lty =</span> <span class="dv">2</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">x =</span> H, <span class="dt">y =</span> <span class="dv">0</span>, <span class="dt">label =</span> name), <span class="dt">data =</span> batter_100, <span class="dt">hjust =</span> <span class="dv">1</span>, <span class="dt">vjust =</span> <span class="dv">1</span>, <span class="dt">angle =</span> <span class="dv">270</span>) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;H (out of 100 at-bats)&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;(Likelihood if pitcher) / (Likelihood if pitcher + Likelihood if not)&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Posterior probability a player is in the pitcher cluster&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/assign-2.png" width="672" /></p>
<ul>
<li>通过构建后验概率，我们可以直接对结果基于概率进行分组</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">career_likelihoods &lt;-<span class="st"> </span>career %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;<span class="st"> </span><span class="dv">20</span>) %&gt;%
<span class="st">  </span><span class="kw">crossing</span>(final_parameters) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">likelihood =</span> prior *<span class="st"> </span>VGAM::<span class="kw">dbetabinom.ab</span>(H, AB, alpha, beta)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(playerID) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">posterior =</span> likelihood /<span class="st"> </span><span class="kw">sum</span>(likelihood))

career_assignments &lt;-<span class="st"> </span>career_likelihoods %&gt;%
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">1</span>, posterior) %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>()
<span class="co"># 对比这种分组与实际数据的结果</span>
career_assignments %&gt;%
<span class="st">  </span><span class="kw">filter</span>(posterior &gt;<span class="st"> </span>.<span class="dv">8</span>) %&gt;%
<span class="st">  </span><span class="kw">count</span>(isPitcher, cluster) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(cluster, n)</code></pre></div>
<pre><code>## Source: local data frame [2 x 3]
## Groups: isPitcher [2]
## 
##   isPitcher     A     B
## *     &lt;lgl&gt; &lt;int&gt; &lt;int&gt;
## 1     FALSE    30  2043
## 2      TRUE   546   141</code></pre>
<ul>
<li>这样基于对概率分布的观察，我们可以实现有现实意义的分组，对分组的改进则需要对数据的进一步理解</li>
</ul>
</div>
<div id="section-19.14.3" class="section level3">
<h3><span class="header-section-number">19.14.3</span> 经验贝叶斯收缩</h3>
<ul>
<li>混合模型下前面所做的工作都需要重新考虑</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 观察击球数100选手的后验概率分布</span>
batting_data &lt;-<span class="st"> </span>career_likelihoods %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB ==<span class="st"> </span><span class="dv">100</span>) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">paste0</span>(name, <span class="st">&quot; (&quot;</span>, H, <span class="st">&quot;/&quot;</span>, AB, <span class="st">&quot;)&quot;</span>),
         <span class="dt">name =</span> <span class="kw">reorder</span>(name, H),
         <span class="dt">alpha1 =</span> H +<span class="st"> </span>alpha,
         <span class="dt">beta1 =</span> AB -<span class="st"> </span>H +<span class="st"> </span>beta)

batting_data %&gt;%
<span class="st">  </span><span class="kw">crossing</span>(<span class="dt">x =</span> <span class="kw">seq</span>(<span class="dv">0</span>, .<span class="dv">4</span>, .<span class="dv">001</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">posterior_density =</span> posterior *<span class="st"> </span><span class="kw">dbeta</span>(x, alpha1, beta1)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(name, x) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">posterior_density =</span> <span class="kw">sum</span>(posterior_density)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x, posterior_density, <span class="dt">color =</span> name)) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">show.legend =</span> <span class="ot">FALSE</span>) +
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="kw">aes</span>(<span class="dt">xintercept =</span> average), <span class="dt">data =</span> batting_data, <span class="dt">lty =</span> <span class="dv">2</span>) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>name) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Batting average (actual average shown as dashed line)&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Posterior density after updating&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/ebayesem-1.png" width="672" /></p>
<ul>
<li>此时不太好判断属于哪一分布，可采用后验概率对平均分布进行加权</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">eb_shrinkage &lt;-<span class="st"> </span>career_likelihoods %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">shrunken_average =</span> (H +<span class="st"> </span>alpha) /<span class="st"> </span>(AB +<span class="st"> </span>alpha +<span class="st"> </span>beta)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(playerID) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">shrunken_average =</span> <span class="kw">sum</span>(posterior *<span class="st"> </span>shrunken_average))
<span class="co"># 观察加权分布</span>
eb_shrinkage %&gt;%
<span class="st">  </span><span class="kw">inner_join</span>(career) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(AB &gt;<span class="st"> </span><span class="dv">50</span>) %&gt;%
<span class="st">  </span><span class="kw">gather</span>(type, value, average, shrunken_average) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="kw">ifelse</span>(type ==<span class="st"> &quot;average&quot;</span>, <span class="st">&quot;Raw batting average&quot;</span>, <span class="st">&quot;Average posterior&quot;</span>),
         <span class="dt">type =</span> <span class="kw">relevel</span>(<span class="kw">factor</span>(type), <span class="st">&quot;Raw batting average&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(AB, value)) +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>type) +
<span class="st">  </span><span class="kw">scale_x_log10</span>() +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Estimate&quot;</span>)</code></pre></div>
<p><img src="Notes_files/figure-html/weightdist-1.png" width="672" /> - 收敛后的分布会朝向两个中心而不是一个，并非所有之前的方法（例如区间估计）都可以适用到混合模型里，需要根据实际情况进行分析</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="section-18.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="python.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/yufree/notes/edit/master/19-ebayes.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
